# Firestore Integration Documentation

This document explains the Firestore database integration for Pasta & Pastries website, including product management and order tracking.

> ðŸš€ **Quick Start**: See [SETUP_GUIDE.md](./SETUP_GUIDE.md) for step-by-step setup instructions.

## Overview

The application now supports dual-mode operation:
- **Development Mode**: Uses mock data (no Firestore reads/writes, zero cost)
- **Production Mode**: Uses Firestore database (real-time data, requires Firebase)

## Architecture

### Environment-Based Configuration

The data source is controlled by the `useMockData` flag in environment files:

**Development (`environment.development.ts`):**
```typescript
export const environment = {
  production: false,
  useMockData: true,  // Uses mock data
  firebase: { /* config */ }
};
```

**Production (`environment.ts`):**
```typescript
export const environment = {
  production: true,
  useMockData: false,  // Uses Firestore
  firebase: { /* config */ }
};
```

### Data Models

#### Product Model (`src/app/models/product.ts`)
```typescript
export interface Product {
  id: string;  // Changed from number to string for Firestore compatibility
  name: string;
  category: 'pasta' | 'pastry';
  description: string;
  price: number;
  image: string;
  ingredients?: string[];
  isBestSeller?: boolean;
  variants?: ProductVariant[];
}
```

#### Order Model (`src/app/models/order.ts`)
```typescript
export interface Order {
  id: string;
  items: CartItem[];
  totalAmount: number;
  customerName?: string;
  customerEmail?: string;
  customerPhone?: string;
  deliveryAddress?: string;
  orderType: 'pickup' | 'delivery';
  specialInstructions?: string;
  orderDate: Date;
  status: 'pending' | 'confirmed' | 'preparing' | 'ready' | 'completed' | 'cancelled';
  userId?: string;  // Firebase Auth user ID (required in production)
}
```

## Services

### ProductsService (`src/app/services/products.service.ts`)

**Methods** (all return Observables):
- `getAllProducts()`: Get all products
- `getBestSellers()`: Get products marked as best sellers
- `getProductsByCategory(category)`: Get products by pasta/pastry category
- `getProductById(id)`: Get single product by ID

**Behavior:**
- **Development**: Returns mock data wrapped in Observable
- **Production**: Queries Firestore with error handling and fallback to mock data

**Error Handling:**
- Logs errors to console
- Falls back to mock data on Firestore errors
- Returns empty arrays/null on failure

### CheckoutService (`src/app/services/checkout.service.ts`)

**Methods** (all return Observables):
- `createOrder(orderType, customerInfo)`: Create new order
- `getOrders()`: Get all orders for current user
- `getOrderById(orderId)`: Get specific order
- `updateOrderStatus(orderId, status)`: Update order status

**Authentication Requirements:**
- **Development**: No authentication required
- **Production**: Requires Firebase Authentication
  - `createOrder()` throws error if user not authenticated
  - `getOrders()` throws error if user not authenticated
  - Orders are associated with `userId` from Firebase Auth

**Behavior:**
- **Development**: Uses localStorage for persistence
- **Production**: Uses Firestore with user-scoped queries

## Firestore Collections

### `products` Collection

**Document Structure:**
```javascript
{
  name: string,
  category: 'pasta' | 'pastry',
  description: string,
  price: number,
  image: string,
  ingredients: string[],
  isBestSeller: boolean,
  variants: [
    {
      id: string,
      label: string,
      price: number,
      servings: string,
      dimensions: string
    }
  ]
}
```

**Document IDs**: Custom IDs ('1', '2', '3', '4')

**Indexes Required:**
- Single field index on `category`
- Single field index on `isBestSeller`

### `orders` Collection

**Document Structure:**
```javascript
{
  items: [
    {
      product: Product,
      quantity: number,
      specialInstructions: string,
      selectedVariant: ProductVariant
    }
  ],
  totalAmount: number,
  customerName: string,
  customerEmail: string,
  customerPhone: string,
  deliveryAddress: string,
  orderType: 'pickup' | 'delivery',
  specialInstructions: string,
  orderDate: Timestamp,
  status: string,
  userId: string  // Firebase Auth UID
}
```

**Document IDs**: Auto-generated by Firestore

**Indexes Required:**
- Single field index on `userId`
- Composite index on `userId` + `orderDate` (for sorting)

## Database Seeding

### Setup Instructions

1. **Install Dependencies** (if needed):
   ```bash
   npm install -D ts-node @types/node
   ```

2. **Run Seeding Script**:
   ```bash
   npx ts-node scripts/seed-firestore-web.ts
   ```

3. **Verify in Firebase Console**:
   - Go to https://console.firebase.google.com/
   - Navigate to Firestore Database > products collection
   - Should see 4 documents with IDs: '1', '2', '3', '4'

### Seeded Products

1. **Lasagna** (ID: '1')
   - Category: pasta
   - Price: 180 (Small), 399 (Medium), 799 (Large)
   - Has 3 variants

2. **Cheesy Baked Mac** (ID: '2')
   - Category: pasta
   - Price: 140

3. **Choco Banana Muffins** (ID: '3')
   - Category: pastry
   - Price: 130

4. **Carrot Muffins** (ID: '4')
   - Category: pastry
   - Price: 260

## Security Rules

**Recommended Firestore Security Rules:**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Products collection - read-only for all, write for authenticated admin users
    match /products/{productId} {
      allow read: if true;  // Public read access
      allow write: if false;  // No client-side writes (use Admin SDK or Firebase Console)
    }

    // Orders collection - users can only access their own orders
    match /orders/{orderId} {
      // Users can read their own orders
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Users can create orders for themselves
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;

      // Users cannot update or delete orders (admin only via Admin SDK)
      allow update, delete: if false;
    }
  }
}
```

**To Deploy Security Rules:**

1. Create `firestore.rules` file in project root
2. Copy the rules above into the file
3. Deploy via Firebase CLI:
   ```bash
   firebase deploy --only firestore:rules
   ```

Or manually update in Firebase Console:
- Go to Firestore Database > Rules tab
- Paste the rules and publish

## Development Workflow

### Running in Development Mode

1. **Start Development Server**:
   ```bash
   npm start
   ```

2. **Verify Mock Data**:
   - Navigate to http://localhost:4200
   - Check browser console - should see no Firestore errors
   - Products should load from mock data
   - Orders saved to localStorage

### Testing Production Mode Locally

1. **Ensure Firestore is Seeded**:
   ```bash
   npx ts-node scripts/seed-firestore-web.ts
   ```

2. **Temporarily Enable Production Mode**:
   - Edit `environment.development.ts`
   - Set `useMockData: false`
   - Save file

3. **Restart Server**:
   ```bash
   npm start
   ```

4. **Sign In Required**:
   - You must sign in with Google to create orders
   - Products will load from Firestore
   - Orders will be saved to Firestore

5. **Revert After Testing**:
   - Set `useMockData: true` in `environment.development.ts`

### Building for Production

**Note**: Production builds currently fail during SSR prerendering if Firestore data is not seeded. This is expected behavior.

**Workaround Options:**

1. **Seed Firestore First**:
   ```bash
   npx ts-node scripts/seed-firestore-web.ts
   npm run build
   ```

2. **Temporarily Disable SSR** (not recommended):
   - Remove prerendering routes from `angular.json`

3. **Use Development Build** (for testing):
   ```bash
   ng build --configuration development
   ```

## Component Updates

### Components Using ProductsService

All components now subscribe to Observables instead of using synchronous data:

**Before:**
```typescript
this.products = this.productsService.getAllProducts();
```

**After:**
```typescript
this.productsService.getAllProducts().subscribe({
  next: (products) => {
    this.products = products;
  },
  error: (error) => {
    console.error('Error loading products:', error);
    this.products = [];
  }
});
```

**Updated Components:**
- `home.component.ts`: Loads best sellers
- `menu.component.ts`: Loads all products with category filtering
- `navbar.component.ts`: Creates orders on checkout

## Error Handling

### ProductsService Errors

**Development Mode:**
- Mock data always returns successfully
- No network errors possible

**Production Mode:**
- Firestore permission errors â†’ Falls back to mock data
- Network errors â†’ Falls back to mock data
- All errors logged to console

### CheckoutService Errors

**Development Mode:**
- localStorage errors (rare) â†’ Alert user
- Empty cart â†’ Returns error observable

**Production Mode:**
- User not authenticated â†’ Throws error with message
- Empty cart â†’ Returns error observable
- Firestore write errors â†’ Alert user to retry
- All errors logged to console

## Cost Optimization

### Development Mode Benefits

By using `useMockData: true` in development:
- **Zero Firestore reads** during local development
- **Zero Firestore writes** during testing
- **Faster page loads** (no network requests)
- **Offline development** possible

### Production Mode Considerations

**Read Operations:**
- Home page: 1 read for best sellers query
- Menu page: 1 read for all products query
- Product detail: 1 read per product view

**Write Operations:**
- Order creation: 1 write per order
- Order updates: 1 write per status change

**Optimization Tips:**
1. Cache products in memory after first load
2. Use Firestore offline persistence (future enhancement)
3. Implement pagination for large product catalogs
4. Batch order status updates

## Future Enhancements

### Potential Improvements

1. **Firestore Offline Persistence**:
   ```typescript
   import { enableIndexedDbPersistence } from '@angular/fire/firestore';
   enableIndexedDbPersistence(firestore);
   ```

2. **Real-time Order Updates**:
   - Use `onSnapshot()` instead of `getDocs()`
   - Orders update automatically when status changes

3. **Product Images in Firebase Storage**:
   - Upload images to Firebase Storage
   - Update `image` field to use Storage URLs

4. **Admin Panel**:
   - CRUD operations for products
   - Order management dashboard
   - Sales analytics

5. **Search and Filtering**:
   - Algolia integration for product search
   - Advanced filtering by ingredients, price range

6. **Payment Integration**:
   - Stripe or PayPal checkout
   - Order status tied to payment status

## Troubleshooting

### Issue: "Missing or insufficient permissions"

**Cause**: Firestore security rules not configured or too restrictive

**Solution**:
1. Check Firebase Console > Firestore Database > Rules
2. Ensure products collection has `allow read: if true;`
3. Ensure orders collection checks `request.auth != null`

### Issue: "Authentication required to place orders"

**Cause**: User not signed in while in production mode

**Solution**:
1. Sign in with Google using the navbar button
2. Or switch to development mode with `useMockData: true`

### Issue: Development server works but build fails

**Cause**: SSR trying to access Firestore during prerendering

**Solution**:
1. Seed Firestore before building: `npx ts-node scripts/seed-firestore-web.ts`
2. Or use development build: `ng build --configuration development`

### Issue: Products not showing up

**Cause**: Firestore not seeded or security rules blocking reads

**Solution**:
1. Run seeding script: `npx ts-node scripts/seed-firestore-web.ts`
2. Check Firebase Console for products
3. Verify security rules allow public reads

## Migration Checklist

If migrating existing code to use this Firestore integration:

- [x] Update Product model `id` from `number` to `string`
- [x] Update all components to subscribe to Observable returns
- [x] Add error handling in component subscriptions
- [x] Update environment files with `useMockData` flag
- [x] Test development mode with mock data
- [x] Seed Firestore with initial products
- [x] Configure Firestore security rules
- [x] Test production mode with Firestore
- [x] Update cart/checkout flow to handle authentication
- [ ] Deploy to production
- [ ] Monitor Firestore usage and costs

## Support

For issues or questions:
1. Check Firebase Console for errors
2. Review browser console for detailed error messages
3. Verify environment configuration
4. Check Firestore security rules
5. Ensure Firebase project is active and billing enabled (if needed)

---

**Last Updated**: 2025-11-09
**Version**: 1.0.0
